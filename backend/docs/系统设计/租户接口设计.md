# 租户注册/管理接口

## 1. 新增租户

### 1.1 租户自助注册

- **路径**: `/api/v1/tenants/register`
- **方法**: `POST`
- **描述**: 租户自助注册，提供公司信息，自动生成tenant_id和管理员账号
- **认证**: 无需认证

#### 请求参数

```json
{
  "name": "示例科技有限公司",
  "domain": "example.com",
  "admin_user": {
    "full_name": "张三",
    "email": "admin@example.com",
    "phone": "13800138000",
    "password": "SecurePassword123!"
  },
  "plan_type": "basic",
  "max_users": 50,
  "max_storage": 10737418240
}
```

#### 请求参数说明

| 字段 | 类型 | 必填 | 描述 | 验证规则 |
|------|------|------|------|----------|
| name | string | 是 | 公司名称 | 长度2-100字符 |
| domain | string | 否 | 公司域名 | 有效的域名格式 |
| admin_user | object | 是 | 管理员用户信息 | - |
| admin_user.full_name | string | 是 | 管理员姓名 | 长度2-50字符 |
| admin_user.email | string | 是 | 管理员邮箱 | 有效的邮箱格式 |
| admin_user.phone | string | 否 | 管理员手机号 | 11位手机号 |
| admin_user.password | string | 是 | 管理员密码 | 长度8-50字符，包含大小写字母和数字 |
| plan_type | string | 否 | 套餐类型 | basic/pro/enterprise，默认basic |
| max_users | integer | 否 | 最大用户数 | 10-10000，默认10 |
| max_storage | integer | 否 | 最大存储空间(字节) | 1GB-1TB，默认1GB |

#### 响应格式

**成功响应 (201 Created)**

```json
{
  "code": 201,
  "message": "租户注册成功",
  "data": {
    "tenant": {
      "id": 1,
      "tenant_id": "tenant_a1b2c3d4",
      "name": "示例科技有限公司",
      "domain": "example.com",
      "status": "pending",
      "plan_type": "basic",
      "max_users": 50,
      "max_storage": 10737418240,
      "schema_name": "tenant_a1b2c3d4",
      "created_at": "2024-01-01T00:00:00Z"
    },
    "admin_user": {
      "id": 1,
      "user_id": "user_e5f6g7h8",
      "username": "admin",
      "email": "admin@example.com",
      "full_name": "张三",
      "role": "super_admin",
      "status": "active"
    },
    "setup_instructions": {
      "schema_created": true,
      "tables_created": true,
      "admin_account_activated": true
    }
  }
}
```

**错误响应 (400 Bad Request)**

```json
{
  "code": 400,
  "message": "请求参数验证失败",
  "errors": [
    {
      "field": "name",
      "message": "公司名称不能为空"
    },
    {
      "field": "admin_user.email",
      "message": "邮箱格式不正确"
    }
  ]
}
```

#### 业务逻辑

1. 验证请求参数
2. 生成唯一的tenant_id和schema_name
3. 创建租户记录（状态为pending）
4. 创建租户schema
5. 在租户schema中创建所有业务表
6. 创建管理员用户账号
7. 发送激活邮件给管理员
8. 返回租户和管理员信息

### 1.2 超级管理员创建租户

- **路径**: `/api/v1/tenants/`
- **方法**: `POST`
- **描述**: 超级管理员创建租户，可指定更多配置
- **认证**: 需要超级管理员权限

#### 请求参数

```json
{
  "name": "企业客户公司",
  "domain": "enterprise.com",
  "admin_user": {
    "full_name": "李四",
    "email": "admin@enterprise.com",
    "phone": "13900139000",
    "password": "EnterprisePass123!"
  },
  "plan_type": "enterprise",
  "max_users": 1000,
  "max_storage": 107374182400,
  "settings": {
    "custom_branding": true,
    "api_rate_limit": 10000,
    "backup_frequency": "daily"
  },
  "status": "active"
}
```

## 2. 激活租户

### 2.1 邮箱验证激活

- **路径**: `/api/v1/tenants/activate`
- **方法**: `POST`
- **描述**: 通过邮箱验证链接激活租户
- **认证**: 无需认证

#### 请求参数

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "password": "NewPassword123!"
}
```

#### 响应格式

**成功响应 (200 OK)**

```json
{
  "code": 200,
  "message": "租户激活成功",
  "data": {
    "tenant_id": "tenant_a1b2c3d4",
    "status": "active",
    "activated_at": "2024-01-01T12:00:00Z"
  }
}
```

### 2.2 超级管理员激活

- **路径**: `/api/v1/tenants/{tenant_id}/activate`
- **方法**: `POST`
- **描述**: 超级管理员手动激活租户
- **认证**: 需要超级管理员权限

#### 响应格式

```json
{
  "code": 200,
  "message": "租户激活成功",
  "data": {
    "tenant_id": "tenant_a1b2c3d4",
    "status": "active",
    "activated_by": "super_admin",
    "activated_at": "2024-01-01T12:00:00Z"
  }
}
```

## 3. 获取租户详情

### 3.1 获取当前租户信息

- **路径**: `/api/v1/tenants/me`
- **方法**: `GET`
- **描述**: 获取当前登录用户所属租户的详细信息
- **认证**: 需要用户登录

#### 响应格式

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": 1,
    "tenant_id": "tenant_a1b2c3d4",
    "name": "示例科技有限公司",
    "domain": "example.com",
    "avatar_url": "https://example.com/avatar.png",
    "status": "active",
    "plan_type": "basic",
    "max_users": 50,
    "current_users": 12,
    "max_storage": 10737418240,
    "current_storage": 2147483648,
    "settings": {
      "custom_branding": false,
      "api_rate_limit": 1000
    },
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T12:00:00Z"
  }
}
```

### 3.2 获取指定租户信息

- **路径**: `/api/v1/tenants/{tenant_id}`
- **方法**: `GET`
- **描述**: 获取指定租户的详细信息
- **认证**: 需要超级管理员权限

#### 路径参数

| 参数 | 类型 | 必填 | 描述 |
|------|------|------|------|
| tenant_id | string | 是 | 租户ID |

#### 响应格式

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": 1,
    "tenant_id": "tenant_a1b2c3d4",
    "name": "示例科技有限公司",
    "domain": "example.com",
    "avatar_url": "https://example.com/avatar.png",
    "status": "active",
    "plan_type": "basic",
    "max_users": 50,
    "current_users": 12,
    "max_storage": 10737418240,
    "current_storage": 2147483648,
    "settings": {
      "custom_branding": false,
      "api_rate_limit": 1000
    },
    "schema_name": "tenant_a1b2c3d4",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T12:00:00Z"
  }
}
```

### 3.3 获取租户列表

- **路径**: `/api/v1/tenants/`
- **方法**: `GET`
- **描述**: 获取租户列表（分页）
- **认证**: 需要超级管理员权限

#### 查询参数

| 参数 | 类型 | 必填 | 描述 | 默认值 |
|------|------|------|------|--------|
| page | integer | 否 | 页码 | 1 |
| size | integer | 否 | 每页数量 | 20 |
| status | string | 否 | 状态过滤 | 全部 |
| plan_type | string | 否 | 套餐类型过滤 | 全部 |
| search | string | 否 | 搜索关键词 | 无 |

#### 响应格式

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "tenants": [
      {
        "id": 1,
        "tenant_id": "tenant_a1b2c3d4",
        "name": "示例科技有限公司",
        "domain": "example.com",
        "status": "active",
        "plan_type": "basic",
        "current_users": 12,
        "max_users": 50,
        "created_at": "2024-01-01T00:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 100,
      "pages": 5
    }
  }
}
```

## 4. 更新租户

### 4.1 更新租户基本信息

- **路径**: `/api/v1/tenants/{tenant_id}`
- **方法**: `PUT`
- **描述**: 更新租户基本信息
- **认证**: 需要超级管理员权限或租户管理员权限

#### 请求参数

```json
{
  "name": "新公司名称",
  "domain": "newdomain.com",
  "avatar_url": "https://newdomain.com/avatar.png",
  "max_users": 100,
  "max_storage": 21474836480,
  "settings": {
    "custom_branding": true,
    "api_rate_limit": 5000
  }
}
```

#### 响应格式

```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "id": 1,
    "tenant_id": "tenant_a1b2c3d4",
    "name": "新公司名称",
    "domain": "newdomain.com",
    "updated_at": "2024-01-01T13:00:00Z"
  }
}
```

### 4.2 升级/降级套餐

- **路径**: `/api/v1/tenants/{tenant_id}/plan`
- **方法**: `PUT`
- **描述**: 更改租户套餐类型
- **认证**: 需要超级管理员权限

#### 请求参数

```json
{
  "plan_type": "pro",
  "max_users": 200,
  "max_storage": 53687091200,
  "effective_date": "2024-02-01T00:00:00Z"
}
```

#### 响应格式

```json
{
  "code": 200,
  "message": "套餐更新成功",
  "data": {
    "tenant_id": "tenant_a1b2c3d4",
    "old_plan": "basic",
    "new_plan": "pro",
    "effective_date": "2024-02-01T00:00:00Z",
    "price_change": 99.00
  }
}
```

## 5. 删除租户

### 5.1 软删除租户

- **路径**: `/api/v1/tenants/{tenant_id}`
- **方法**: `DELETE`
- **描述**: 软删除租户（标记为inactive）
- **认证**: 需要超级管理员权限

#### 响应格式

```json
{
  "code": 200,
  "message": "租户删除成功",
  "data": {
    "tenant_id": "tenant_a1b2c3d4",
    "status": "inactive",
    "deleted_at": "2024-01-01T14:00:00Z"
  }
}
```

### 5.2 硬删除租户

- **路径**: `/api/v1/tenants/{tenant_id}/permanent`
- **方法**: `DELETE`
- **描述**: 永久删除租户及其所有数据
- **认证**: 需要超级管理员权限

#### 请求参数

```json
{
  "confirmation": "DELETE_TENANT_PERMANENTLY",
  "backup_data": true
}
```

#### 响应格式

```json
{
  "code": 200,
  "message": "租户永久删除成功",
  "data": {
    "tenant_id": "tenant_a1b2c3d4",
    "backup_created": true,
    "backup_location": "/backups/tenant_a1b2c3d4_20240101_140000.sql",
    "deleted_at": "2024-01-01T14:00:00Z"
  }
}
```

## 6. 租户状态管理

### 6.1 暂停租户

- **路径**: `/api/v1/tenants/{tenant_id}/suspend`
- **方法**: `POST`
- **描述**: 暂停租户服务
- **认证**: 需要超级管理员权限

#### 请求参数

```json
{
  "reason": "账户余额不足",
  "suspension_duration": "7d",
  "notify_users": true
}
```

#### 响应格式

```json
{
  "code": 200,
  "message": "租户已暂停",
  "data": {
    "tenant_id": "tenant_a1b2c3d4",
    "status": "suspended",
    "suspended_at": "2024-01-01T15:00:00Z",
    "suspension_reason": "账户余额不足",
    "estimated_reactivation": "2024-01-08T15:00:00Z"
  }
}
```

### 6.2 恢复租户

- **路径**: `/api/v1/tenants/{tenant_id}/reactivate`
- **方法**: `POST`
- **描述**: 恢复暂停的租户
- **认证**: 需要超级管理员权限

#### 响应格式

```json
{
  "code": 200,
  "message": "租户已恢复",
  "data": {
    "tenant_id": "tenant_a1b2c3d4",
    "status": "active",
    "reactivated_at": "2024-01-01T16:00:00Z"
  }
}
```

## 7. 租户统计信息

### 7.1 获取租户使用统计

- **路径**: `/api/v1/tenants/{tenant_id}/stats`
- **方法**: `GET`
- **描述**: 获取租户的使用统计信息
- **认证**: 需要超级管理员权限或租户管理员权限

#### 响应格式

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "tenant_id": "tenant_a1b2c3d4",
    "user_stats": {
      "total_users": 12,
      "active_users": 10,
      "inactive_users": 2,
      "new_users_this_month": 3
    },
    "storage_stats": {
      "total_storage": 2147483648,
      "used_storage": 1073741824,
      "storage_percentage": 50.0
    },
    "api_stats": {
      "total_requests": 15000,
      "requests_this_month": 5000,
      "rate_limit": 1000
    },
    "billing_stats": {
      "current_plan": "basic",
      "monthly_cost": 29.99,
      "next_billing_date": "2024-02-01T00:00:00Z"
    }
  }
}
```

## 8. 错误处理

### 8.1 通用错误响应格式

```json
{
  "code": 400,
  "message": "错误描述",
  "errors": [
    {
      "field": "字段名",
      "message": "具体错误信息",
      "code": "ERROR_CODE"
    }
  ]
}
```

### 8.2 常见错误码

| 错误码 | HTTP状态码 | 描述 |
|--------|------------|------|
| TENANT_NOT_FOUND | 404 | 租户不存在 |
| TENANT_ALREADY_EXISTS | 409 | 租户已存在 |
| INSUFFICIENT_PERMISSIONS | 403 | 权限不足 |
| TENANT_SUSPENDED | 423 | 租户已暂停 |
| SCHEMA_CREATION_FAILED | 500 | Schema创建失败 |
| INVALID_TENANT_ID | 400 | 无效的租户ID |
| PLAN_UPGRADE_FAILED | 400 | 套餐升级失败 |

## 9. 接口限流

### 9.1 限流规则

- **租户注册**: 每个IP每小时最多5次
- **租户查询**: 每个用户每分钟最多100次
- **租户更新**: 每个租户每小时最多10次
- **租户删除**: 每个超级管理员每小时最多5次

### 9.2 限流响应

```json
{
  "code": 429,
  "message": "请求过于频繁，请稍后再试",
  "retry_after": 3600
}
```

## 10. 安全考虑

### 10.1 认证要求

- 所有管理接口需要适当的权限验证
- 租户信息查询需要验证用户是否属于该租户
- 敏感操作需要二次确认

### 10.2 数据验证

- 所有输入参数进行严格验证
- 防止SQL注入和XSS攻击
- 敏感信息加密存储

### 10.3 审计日志

- 记录所有租户相关操作
- 包含操作人、操作时间、操作内容
- 支持操作回滚和追踪
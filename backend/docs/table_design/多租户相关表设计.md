# 多租户模型使用说明

## 概述

本项目实现了完整的多租户数据模型，包括租户管理、用户管理、角色权限、邀请系统和审计日志。

## 模型结构

### 1. 租户模型 (Tenant)
- **功能**：管理租户基本信息
- **关键字段**：
  - `tenant_id`: 租户唯一标识
  - `name`: 租户名称
  - `domain`: 租户域名
  - `avatar_url`: 租户头像
  - `status`: 租户状态 (active/suspended/inactive)
  - `plan_type`: 套餐类型 (basic/pro/enterprise)
  - `max_users`: 最大用户数
  - `max_storage`: 最大存储空间
  - `settings`: 租户配置 (JSONB)

### 2. 用户模型 (User)
- **功能**：管理用户信息
- **关键字段**：
  - `user_id`: 用户业务标识
  - `tenant_id`: 所属租户
  - `username`: 用户名
  - `email`: 邮箱
  - `full_name`: 姓名
  - `status`: 用户状态 (active/inactive/suspended)
  - `role`: 用户角色 (super_admin/admin/user)

### 3. 角色模型 (Role)
- **功能**：定义角色和权限
- **关键字段**：
  - `tenant_id`: 所属租户
  - `name`: 角色名称
  - `description`: 角色描述
  - `permissions`: 权限配置 (JSONB)
  - `is_system`: 是否系统角色

### 4. 用户角色关联 (UserRole)
- **功能**：用户与角色的多对多关系
- **关键字段**：
  - `tenant_id`: 所属租户
  - `user_id`: 用户ID
  - `role_id`: 角色ID
  - `assigned_by`: 分配人

### 5. 租户邀请 (TenantInvitation)
- **功能**：管理用户邀请
- **关键字段**：
  - `tenant_id`: 所属租户
  - `email`: 被邀请邮箱
  - `token`: 邀请令牌
  - `status`: 邀请状态 (pending/accepted/expired)
  - `expires_at`: 过期时间

### 6. 审计日志 (AuditLog)
- **功能**：记录系统操作日志
- **关键字段**：
  - `tenant_id`: 所属租户
  - `user_id`: 操作用户
  - `action`: 操作类型
  - `resource_type`: 资源类型
  - `resource_id`: 资源ID
  - `details`: 详细信息 (JSONB)

## 使用示例

### 创建租户
```python
from models import Tenant
from sqlalchemy.orm import Session

def create_tenant(db: Session, tenant_data: dict):
    tenant = Tenant(
        tenant_id=tenant_data["tenant_id"],
        name=tenant_data["name"],
        domain=tenant_data.get("domain"),
        status="active",
        plan_type="basic"
    )
    db.add(tenant)
    db.commit()
    db.refresh(tenant)
    return tenant
```

### 创建用户
```python
from models import User
import uuid

def create_user(db: Session, user_data: dict, tenant_id: str):
    user = User(
        user_id=f"user_{uuid.uuid4().hex[:8]}",
        tenant_id=tenant_id,
        username=user_data["username"],
        email=user_data["email"],
        hashed_password=user_data["hashed_password"],
        full_name=user_data.get("full_name"),
        status="active",
        role="user"
    )
    db.add(user)
    db.commit()
    db.refresh(user)
    return user
```

### 查询租户用户
```python
def get_tenant_users(db: Session, tenant_id: str):
    return db.query(User).filter(User.tenant_id == tenant_id).all()
```

### 分配用户角色
```python
from models import UserRole

def assign_user_role(db: Session, tenant_id: str, user_id: int, role_id: int, assigned_by: int):
    user_role = UserRole(
        tenant_id=tenant_id,
        user_id=user_id,
        role_id=role_id,
        assigned_by=assigned_by
    )
    db.add(user_role)
    db.commit()
    return user_role
```

### 记录审计日志
```python
from models import AuditLog

def log_action(db: Session, tenant_id: str, user_id: int, action: str, 
               resource_type: str = None, resource_id: str = None, details: dict = None):
    audit_log = AuditLog(
        tenant_id=tenant_id,
        user_id=user_id,
        action=action,
        resource_type=resource_type,
        resource_id=resource_id,
        details=details
    )
    db.add(audit_log)
    db.commit()
    return audit_log
```

## 数据隔离

所有查询都应该包含 `tenant_id` 条件以确保数据隔离：

```python
# 正确的查询方式
users = db.query(User).filter(User.tenant_id == current_tenant_id).all()

# 错误的查询方式（可能导致数据泄露）
users = db.query(User).all()
```

## 索引优化

模型已经包含了必要的索引：
- 租户ID索引
- 用户ID索引
- 复合索引（租户ID + 业务字段）

## 注意事项

1. **外键约束**：目前没有设置外键约束以避免循环引用，需要在应用层确保数据一致性
2. **枚举类型**：使用PostgreSQL ENUM类型确保数据完整性
3. **时间字段**：所有时间字段使用 `TIMESTAMP WITH TIME ZONE` 确保时区一致性
4. **JSONB字段**：权限和配置使用JSONB类型提供灵活性

## 迁移管理

使用Alembic管理数据库迁移：

```bash
# 生成迁移
alembic revision --autogenerate -m "描述"

# 应用迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1
```

# 项目架构说明

## 整体架构

本项目采用分层架构设计，遵循依赖倒置原则，确保各层之间的解耦和可维护性。

## 目录结构

```
app/
├── core/                    # 核心基础设施层
│   ├── pq_db.py           # 数据库连接和配置
│   ├── schema_manager.py  # PostgreSQL Schema管理
│   └── tenant_context.py  # 租户上下文管理
├── models/                 # 数据模型层
│   ├── __init__.py
│   ├── tenant.py          # 租户模型
│   ├── user.py            # 用户模型
│   ├── role.py            # 角色模型
│   ├── user_role.py       # 用户角色关联模型
│   ├── tenant_invitation.py # 租户邀请模型
│   └── audit_log.py       # 审计日志模型
├── repos/                  # 数据访问层 (Repository Pattern)
│   ├── __init__.py
│   └── tenant/
│       ├── __init__.py
│       └── tenant_repo.py # 租户数据访问
├── services/               # 业务逻辑层
│   ├── __init__.py
│   └── tenant/
│       ├── __init__.py
│       └── tenane_service.py # 租户业务逻辑
├── api/                    # API接口层 (待实现)
├── alembic/                # 数据库迁移
└── main.py                 # 应用入口
```

## 分层架构详解

### 1. 核心基础设施层 (Core Layer)

**职责**: 提供基础技术支持和配置
- **pq_db.py**: 数据库连接池、会话管理
- **schema_manager.py**: PostgreSQL Schema管理工具
- **tenant_context.py**: 租户上下文管理，支持多租户隔离

**特点**: 
- 与技术实现细节相关
- 被上层依赖，不依赖上层
- 提供稳定的基础设施支持

### 2. 数据模型层 (Models Layer)

**职责**: 定义数据结构和ORM映射
- 使用SQLAlchemy ORM
- 定义数据库表结构
- 支持多租户Schema隔离

**特点**:
- 纯数据定义，无业务逻辑
- 被Repo层和Service层使用
- 与数据库结构紧密相关

### 3. 数据访问层 (Repository Layer)

**职责**: 封装数据访问逻辑
- **TenantRepo**: 租户相关的所有数据库操作
- 提供CRUD操作接口
- 处理SQL查询和事务

**特点**:
- 封装所有数据库访问细节
- 提供统一的数据访问接口
- 被Service层调用，不直接暴露给上层

### 4. 业务逻辑层 (Service Layer)

**职责**: 实现业务逻辑和规则
- **TenantService**: 租户相关的所有业务逻辑
- 数据验证、业务规则、流程控制
- 协调多个Repo和外部服务

**特点**:
- 不直接访问数据库
- 通过Repo层访问数据
- 包含复杂的业务逻辑和规则

### 5. API接口层 (API Layer) - 待实现

**职责**: 提供HTTP接口
- 请求参数验证
- 调用Service层处理业务逻辑
- 返回标准化的响应格式

## 依赖关系

```
API Layer → Service Layer → Repository Layer → Models Layer
                ↓
            Core Layer
```

- **单向依赖**: 上层依赖下层，下层不依赖上层
- **接口隔离**: 每层通过接口与上层交互
- **依赖注入**: 通过构造函数注入依赖

## 设计原则

### 1. 单一职责原则 (SRP)
- 每个类只负责一个功能领域
- 例如：TenantRepo只负责租户数据访问，TenantService只负责租户业务逻辑

### 2. 开闭原则 (OCP)
- 对扩展开放，对修改关闭
- 通过接口和抽象类实现扩展性

### 3. 依赖倒置原则 (DIP)
- 高层模块不依赖低层模块
- 都依赖抽象，抽象不依赖具体实现

### 4. 接口隔离原则 (ISP)
- 客户端不应该依赖它不需要的接口
- 每个接口都是专用的

## 多租户架构

### Schema隔离策略
- 每个租户使用独立的PostgreSQL Schema
- 公共Schema存储租户管理信息
- 租户Schema存储业务数据

### 租户上下文管理
- 通过中间件自动识别租户
- 动态切换数据库Schema
- 支持子域名、路径、请求头等多种识别方式

## 数据流

### 创建租户流程
1. **API层**: 接收HTTP请求，验证参数
2. **Service层**: 验证业务规则，生成租户ID
3. **Repo层**: 检查唯一性，创建租户记录
4. **Core层**: 创建Schema，创建业务表
5. **Service层**: 创建管理员用户，提交事务
6. **API层**: 返回响应结果

### 查询租户流程
1. **API层**: 接收查询请求
2. **Service层**: 调用Repo层获取数据
3. **Repo层**: 执行数据库查询
4. **Service层**: 格式化响应数据
5. **API层**: 返回结果

## 扩展性设计

### 新增功能
- 在对应层添加新的类或方法
- 遵循现有架构模式
- 通过依赖注入集成

### 新增租户类型
- 扩展Tenant模型
- 在Service层添加业务逻辑
- 在Repo层添加数据访问方法

### 新增数据源
- 实现新的Repo接口
- 在Service层注入新的Repo
- 保持接口一致性

## 测试策略

### 单元测试
- **Repo层**: 测试数据访问逻辑
- **Service层**: 测试业务逻辑
- **Core层**: 测试基础设施功能

### 集成测试
- 测试层间交互
- 测试数据库操作
- 测试Schema管理

### 端到端测试
- 测试完整业务流程
- 测试多租户隔离
- 测试性能和安全

## 部署考虑

### 数据库
- PostgreSQL 12+
- 支持Schema隔离
- 适当的连接池配置

### 应用服务器
- 支持多进程/多线程
- 租户上下文隔离
- 连接池管理

### 监控和日志
- 租户级别的操作日志
- 性能监控
- 错误追踪

## 总结

这种分层架构设计提供了以下优势：

1. **可维护性**: 清晰的职责分离，易于理解和修改
2. **可测试性**: 每层可以独立测试
3. **可扩展性**: 新功能可以按层添加
4. **可重用性**: 底层功能可以被多个上层使用
5. **解耦性**: 层间通过接口交互，降低耦合度

通过严格遵循分层原则和依赖关系，我们构建了一个健壮、可维护的多租户应用架构。
